name: Fetch FX daily

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '7 2 * * *'

permissions:
  contents: write

concurrency:
  group: fx-daily
  cancel-in-progress: false

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # needed for rebase

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Debug token presence and length (masked)
        env:
          WISE_TOKEN: ${{ secrets.WISE_TOKEN }}
        run: |
          if [[ -n "$WISE_TOKEN" ]]; then
            echo "WISE_TOKEN present: yes"
            echo "WISE_TOKEN length: ${#WISE_TOKEN}"
          else
            echo "WISE_TOKEN present: no"
            exit 2
          fi

      - name: Auth smoke test (GET /v1/profiles)
        env:
          WISE_TOKEN: ${{ secrets.WISE_TOKEN }}
        run: |
          CODE=$(curl -sS -o /tmp/profiles.json -w '%{http_code}' \
            -H "Authorization: Bearer $WISE_TOKEN" \
            https://api.transferwise.com/v1/profiles)
          echo "GET /v1/profiles HTTP $CODE"
          if [[ "$CODE" != 2* ]]; then
            echo "Body (first 400 chars):"
            head -c 400 /tmp/profiles.json || true
            exit 2
          fi
          echo "Profiles count: $(jq 'length' /tmp/profiles.json)"

      - name: Fetch latest FX data
        env:
          WISE_TOKEN: ${{ secrets.WISE_TOKEN }}
        run: bash scripts/fetch_fx.sh

      - name: Show data size and preview
        run: |
          ls -l data || true
          if [[ -f data/latest.json ]]; then
            echo "Bytes in data/latest.json: $(wc -c < data/latest.json)"
            head -c 400 data/latest.json || true
            echo
          else
            echo "data/latest.json not found"
          fi

      - name: Commit & push data (rebase-safe)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/latest.json data/snapshots/ || true
          git commit -m "chore(data): daily update $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "No changes to commit"

          # Rebase onto the latest main to avoid non-fast-forward errors
          git pull --rebase --autostash origin main || true

          # Push; retry once if there was a race
          git push origin HEAD:main || (git pull --rebase --autostash origin main && git push origin HEAD:main)
