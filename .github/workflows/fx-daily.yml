name: Fetch FX daily

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '7 2 * * *'

permissions:
  contents: write

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ---------- Wise (unchanged) ----------
      - name: Debug token presence and length (masked)
        shell: bash
        env:
          WISE_TOKEN: ${{ secrets.WISE_TOKEN }}
        run: |
          if [[ -n "$WISE_TOKEN" ]]; then
            echo "WISE_TOKEN present: yes"
            echo "WISE_TOKEN length: ${#WISE_TOKEN}"
          else
            echo "WISE_TOKEN present: no"
          fi

      - name: Auth smoke test (GET /v1/profiles)
        shell: bash
        env:
          WISE_TOKEN: ${{ secrets.WISE_TOKEN }}
        run: |
          CODE=$(curl -sS -o /tmp/profiles.json -w '%{http_code}' \
            -H "Authorization: Bearer $WISE_TOKEN" \
            https://api.transferwise.com/v1/profiles)
          echo "GET /v1/profiles HTTP $CODE"
          if [[ "$CODE" != 2* ]]; then
            echo "Body (first 400 chars):"
            head -c 400 /tmp/profiles.json || true
            exit 2
          fi
          echo "Profiles count: $(jq 'length' /tmp/profiles.json)"

      - name: Fetch latest FX data (Wise)
        shell: bash
        env:
          WISE_TOKEN: ${{ secrets.WISE_TOKEN }}
        run: bash scripts/fetch_fx.sh

      - name: Show Wise data size and preview
        shell: bash
        run: |
          ls -l data || true
          if [[ -f data/latest.json ]]; then
            echo "Bytes in data/latest.json: $(wc -c < data/latest.json)"
            head -c 400 data/latest.json || true
            echo
          else
            echo "data/latest.json not found"
          fi

      # ---------- Kraken CEX (new) ----------
      # Secrets you add in repo settings:
      #   KRAKEN_API_KEY, KRAKEN_API_SECRET  (read-only key)
      - name: Fetch CEX path (Kraken USD→USDC→GBP)
        shell: bash
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          # keep the run fast:
          USD_ANCHORS: 1000,10000
        run: |
          if [[ -z "$KRAKEN_API_KEY" || -z "$KRAKEN_API_SECRET" ]]; then
            echo "Kraken secrets not set; skipping CEX step."
            exit 0
          fi
          bash scripts/fetch_cex_simple.sh

      - name: Show Kraken CEX preview
        shell: bash
        run: |
          if [[ -f data/cex_simple.json ]]; then
            echo "Rows in data/cex_simple.json: $(jq 'length' data/cex_simple.json)"
            jq -r '.[0]' data/cex_simple.json || true
          else
            echo "data/cex_simple.json not found (CEX step may have been skipped)."
          fi

      # ---------- Commit ----------
      - name: Commit & push data
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add \
            data/latest.json \
            data/history/*.jsonl \
            data/cex_simple.json \
            data/snapshots/*.json \
            data/snapshots/manifest.json 2>/dev/null || true
          git commit -m "chore(data): daily update $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "No changes to commit"
          git push
