<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FX Cost Curves</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    h1{font-size:44px;margin:0 0 8px}
    .muted{color:#666;margin:0 0 16px}
    .controls{display:flex;gap:12px;align-items:center;margin:8px 0 16px;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .title{font-weight:800;font-size:26px;letter-spacing:.2px;margin:4px 0 12px}
    canvas{width:100% !important;height:420px !important}
    button.swap{padding:6px 10px;border:1px solid #ddd;border-radius:10px;background:#fafafa;cursor:pointer}
    select{padding:6px 8px;border:1px solid #ddd;border-radius:10px;background:#fff}
  </style>
</head>
<body>
  <h1>FX Cost Curves</h1>
  <p class="muted">Daily Wise quotes. Y-axis is fee in <b>bps vs mid outcome</b>. X-axis is source amount.</p>

  <div class="controls">
    <label>From:</label>
    <select id="from"></select>
    <button id="swap" class="swap" title="Swap">⇆</button>
    <label>To:</label>
    <select id="to"></select>

    <span style="width:24px"></span>

    <label>Mode:</label>
    <select id="mode">
      <option value="BALANCE" selected>BALANCE</option>
      <option value="ALL">ALL</option>
      <option value="BANK_TRANSFER">BANK_TRANSFER</option>
    </select>

    <span id="badge" class="muted"></span>
  </div>

  <div class="card">
    <div id="title" class="title"></div>
    <canvas id="chart"></canvas>
  </div>

  <script>
    const fmtK = n => {
      const x = Number(n);
      if (!isFinite(x)) return String(n);
      if (x >= 1_000_000) return (x/1_000_000).toFixed(0) + "M";
      if (x >= 1000) return (x/1000).toFixed(0) + "k";
      return String(x);
    };

    async function loadData() {
      const res = await fetch('data/latest.json?nocache=' + Date.now());
      if (!res.ok) throw new Error('Failed to load data/latest.json');
      return res.json();
    }

    const yVal = d => {
      const y = d.fee_bps ?? d.bps ?? d.bps_vs_mid ?? d.y;
      const v = Number(y);
      return Number.isFinite(v) ? v : null;
    };
    const xVal = d => {
      const x = d.amount ?? d.sourceAmount ?? d.x;
      const v = Number(x);
      return Number.isFinite(v) ? v : null;
    };

    function uniqueSortedCurrencies(rows){
      const s = new Set();
      for (const r of rows){
        s.add(String(r.src ?? r.sourceCurrency));
        s.add(String(r.tgt ?? r.targetCurrency));
      }
      return Array.from(s).filter(Boolean).sort();
    }

    function filterPair(rows, from, to, mode){
      return rows.filter(r => {
        const src = r.src ?? r.sourceCurrency;
        const tgt = r.tgt ?? r.targetCurrency;
        const m = r.mode ?? r.payOut;
        if (src !== from || tgt !== to) return false;
        if (mode === 'ALL') return true;
        return (m === mode);
      });
    }

    // --- NEW: smart y-domain with headroom/tailroom ---
    function yDomain(points){
      if (!points.length) return {min:0, max:1};
      const ys = points.map(p => p.y);
      const yMinRaw = Math.min(...ys);
      const yMaxRaw = Math.max(...ys);
      const span = yMaxRaw - yMinRaw;

      // 15–20% padding, at least 2 bps; if span is very tight, ensure ~5–8 bps total padding
      let pad = Math.max(span * 0.18, 2);
      if (span < 8) pad = Math.max(pad, 4);

      let yMin = Math.max(0, yMinRaw - pad);
      let yMax = yMaxRaw + pad;

      // Round to nice 5-bps ticks
      yMin = Math.floor(yMin / 5) * 5;
      yMax = Math.ceil(yMax / 5) * 5;
      if (yMax <= yMin) yMax = yMin + 5;

      return {min: yMin, max: yMax};
    }

    (async function init(){
      const rows = await loadData();

      // Populate currency dropdowns
      const curList = uniqueSortedCurrencies(rows);
      const fromEl = document.getElementById('from');
      const toEl = document.getElementById('to');
      const modeEl = document.getElementById('mode');
      const swapBtn = document.getElementById('swap');
      const titleEl = document.getElementById('title');
      const badgeEl = document.getElementById('badge');

      for (const c of curList){
        const o1 = document.createElement('option'); o1.value = o1.textContent = c; fromEl.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = o2.textContent = c; toEl.appendChild(o2);
      }
      // Defaults: GBP -> USD
      if (curList.includes('GBP')) fromEl.value = 'GBP';
      if (curList.includes('USD')) toEl.value = 'USD';
      if (fromEl.value === toEl.value) toEl.value = curList.find(c => c !== fromEl.value) || curList[0];

      const ctx = document.getElementById('chart').getContext('2d');
      let chart = null;

      function render(){
        const from = fromEl.value;
        const to = toEl.value;
        const mode = modeEl.value;

        const items = filterPair(rows, from, to, mode);
        const points = items
          .map(d => ({ x: xVal(d), y: yVal(d) }))
          .filter(p => Number.isFinite(p.x) && Number.isFinite(p.y))
          .sort((a,b) => a.x - b.x);

        const {min: yMin, max: yMax} = yDomain(points);
        titleEl.textContent = `${from}->${to} (${mode})`;
        badgeEl.textContent = `Points: ${points.length}`;

        const data = {
          datasets: [{
            label: `${from}->${to} (${mode})`,
            data: points,
            borderWidth: 2,
            pointRadius: 3,
            tension: 0.2,
            spanGaps: true
          }]
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => ` amount ${ctx.parsed.x}, fee ${ctx.parsed.y.toFixed(2)} bps`
              }
            }
          },
          scales: {
            x: {
              type: 'logarithmic',
              min: points.length ? Math.min(...points.map(p=>p.x)) : 10,
              max: points.length ? Math.max(...points.map(p=>p.x)) : 1_000_000,
              ticks: { callback: v => fmtK(v) },
              title: { display: true, text: 'Source Amount' }
            },
            y: {
              // No beginAtZero; use smart domain so the series isn’t stuck at the top
              min: yMin,
              max: yMax,
              ticks: {
                callback: v => Number(v).toFixed(0) // whole-bps ticks
              },
              title: { display: true, text: 'Fee (bps) vs Mid' }
            }
          }
        };

        if (!chart){
          chart = new Chart(ctx, { type: 'line', data, options });
        } else {
          chart.data = data;
          chart.options = options;
          chart.update();
        }
      }

      fromEl.addEventListener('change', render);
      toEl.addEventListener('change', render);
      modeEl.addEventListener('change', render);
      document.getElementById('swap').addEventListener('click', () => {
        const a = fromEl.value; fromEl.value = toEl.value; toEl.value = a; render();
      });

      render();
    })().catch(err => {
      document.querySelector('.card').innerHTML =
        '<div class="muted">Failed to load charts: ' + err.message + '</div>';
      console.error(err);
    });
  </script>
</body>
</html>
